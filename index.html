<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Track income and expenses on any device">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <style>
        .tab-active {
            border-bottom: 3px solid #2563eb;
            color: #2563eb;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }
        @media (max-width: 640px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <h1 class="text-2xl font-bold text-blue-600">Expense Tracker</h1>
                <div class="flex gap-4 items-center flex-wrap">
                    <div class="text-sm">
                        <span class="font-semibold">CBA:</span>
                        <span id="cba-balance" class="text-green-600 font-bold">$0.00</span>
                    </div>
                    <div class="text-sm">
                        <span class="font-semibold">Westpac:</span>
                        <span id="westpac-balance" class="text-green-600 font-bold">$0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex overflow-x-auto">
                <button class="nav-tab tab-active px-4 py-3 font-medium whitespace-nowrap" data-tab="dashboard">Dashboard</button>
                <button class="nav-tab px-4 py-3 font-medium whitespace-nowrap" data-tab="transactions">Transactions</button>
                <button class="nav-tab px-4 py-3 font-medium whitespace-nowrap" data-tab="budgets">Budgets</button>
                <button class="nav-tab px-4 py-3 font-medium whitespace-nowrap" data-tab="debts">Debts</button>
                <button class="nav-tab px-4 py-3 font-medium whitespace-nowrap" data-tab="reports">Reports</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-gray-500 text-sm font-medium">Total Income</h3>
                    <p id="total-income" class="text-3xl font-bold text-green-600">$0.00</p>
                    <p class="text-xs text-gray-400 mt-1">This month</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-gray-500 text-sm font-medium">Total Expenses</h3>
                    <p id="total-expenses" class="text-3xl font-bold text-red-600">$0.00</p>
                    <p class="text-xs text-gray-400 mt-1">This month</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-gray-500 text-sm font-medium">Net Balance</h3>
                    <p id="net-balance" class="text-3xl font-bold text-blue-600">$0.00</p>
                    <p class="text-xs text-gray-400 mt-1">This month</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Category Breakdown</h3>
                    <canvas id="category-chart"></canvas>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">6-Month Trend</h3>
                    <canvas id="trend-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="search-input" placeholder="Search description..." class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="filter-category" class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Categories</option>
                        </select>
                        <select id="filter-account" class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Accounts</option>
                            <option value="CBA">CBA</option>
                            <option value="Westpac">Westpac</option>
                        </select>
                        <input type="month" id="filter-month" class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Account</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-tbody" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <div id="empty-transactions" class="p-12 text-center hidden">
                    <p class="text-gray-500 mb-4">No transactions yet</p>
                    <button onclick="openTransactionModal()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">Add Transaction</button>
                </div>
                <div id="pagination" class="p-4 border-t flex justify-between items-center">
                    <button id="prev-page" class="px-4 py-2 border rounded-md hover:bg-gray-50" disabled>Previous</button>
                    <span id="page-info" class="text-sm text-gray-600">Page 1</span>
                    <button id="next-page" class="px-4 py-2 border rounded-md hover:bg-gray-50" disabled>Next</button>
                </div>
            </div>
            <button onclick="openTransactionModal()" class="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg hover:bg-blue-700 text-2xl z-30">+</button>
        </div>

        <!-- Budgets Tab -->
        <div id="budgets-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Monthly Budgets</h2>
                    <button onclick="openBudgetModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Set Budget</button>
                </div>
                <div id="budgets-list" class="space-y-4">
                </div>
                <div id="empty-budgets" class="text-center py-12 hidden">
                    <p class="text-gray-500 mb-4">No budgets set</p>
                    <button onclick="openBudgetModal()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">Set Your First Budget</button>
                </div>
            </div>
        </div>

        <!-- Debts Tab -->
        <div id="debts-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Debt Tracking</h2>
                    <button onclick="openDebtModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Add Debt</button>
                </div>
                <div id="debts-list" class="space-y-4">
                </div>
                <div id="empty-debts" class="text-center py-12 hidden">
                    <p class="text-gray-500 mb-4">No debts tracked</p>
                    <button onclick="openDebtModal()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">Add Debt</button>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Import Data</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Import Excel File</label>
                            <input type="file" id="excel-import" accept=".xlsx,.xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <p class="text-xs text-gray-500 mt-1">Import transactions from Excel (your format)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Import JSON Backup</label>
                            <input type="file" id="json-import" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <p class="text-xs text-gray-500 mt-1">Restore from JSON backup</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Export Data</h2>
                    <div class="space-y-3">
                        <button onclick="exportToExcel()" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Export to Excel</button>
                        <button onclick="exportToJSON()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Export JSON Backup</button>
                        <div class="pt-3 border-t">
                            <button onclick="clearAllData()" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Clear All Data</button>
                            <p class="text-xs text-gray-500 mt-1">Warning: This will delete all data permanently</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Transaction Modal -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <div class="bg-white p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold" id="transaction-modal-title">Add Transaction</h2>
                    <button onclick="closeTransactionModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="transaction-form" class="space-y-4">
                    <input type="hidden" id="transaction-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="transaction-date" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <input type="text" id="transaction-description" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <select id="transaction-type" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="expense">Expense</option>
                                <option value="income">Income</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                            <input type="number" id="transaction-amount" step="0.01" min="0.01" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="transaction-category" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Account</label>
                        <select id="transaction-account" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="CBA">CBA</option>
                            <option value="Westpac">Westpac</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
                        <textarea id="transaction-notes" rows="3" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save</button>
                        <button type="button" onclick="closeTransactionModal()" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Budget Modal -->
    <div id="budget-modal" class="modal">
        <div class="modal-content">
            <div class="bg-white p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Set Budget</h2>
                    <button onclick="closeBudgetModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="budget-form" class="space-y-4">
                    <input type="hidden" id="budget-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="budget-category" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Limit</label>
                        <input type="number" id="budget-limit" step="0.01" min="0.01" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save</button>
                        <button type="button" onclick="closeBudgetModal()" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Debt Modal -->
    <div id="debt-modal" class="modal">
        <div class="modal-content">
            <div class="bg-white p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold" id="debt-modal-title">Add Debt</h2>
                    <button onclick="closeDebtModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="debt-form" class="space-y-4">
                    <input type="hidden" id="debt-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Debt Name</label>
                        <input type="text" id="debt-name" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Amount</label>
                        <input type="number" id="debt-total" step="0.01" min="0.01" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save</button>
                        <button type="button" onclick="closeDebtModal()" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <div class="bg-white p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Record Payment</h2>
                    <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <form id="payment-form" class="space-y-4">
                    <input type="hidden" id="payment-debt-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Amount</label>
                        <input type="number" id="payment-amount" step="0.01" min="0.01" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Date</label>
                        <input type="date" id="payment-date" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Record Payment</button>
                        <button type="button" onclick="closePaymentModal()" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Categories
        const CATEGORIES = {
            income: ['Income'],
            expense: ['Groceries', 'Dining Out', 'Transport', 'Fuel', 'Healthcare', 'Medication', 'Entertainment', 'Shopping', 'Utilities', 'Rent', 'Insurance', 'Savings', 'Debt Payment', 'Other']
        };

        // IndexedDB setup
        let db;
        const DB_NAME = 'ExpenseTrackerDB';
        const DB_VERSION = 1;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;

                    if (!db.objectStoreNames.contains('transactions')) {
                        const transactionStore = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        transactionStore.createIndex('date', 'date', { unique: false });
                        transactionStore.createIndex('category', 'category', { unique: false });
                        transactionStore.createIndex('account', 'account', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('budgets')) {
                        db.createObjectStore('budgets', { keyPath: 'id', autoIncrement: true });
                    }

                    if (!db.objectStoreNames.contains('debts')) {
                        const debtStore = db.createObjectStore('debts', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        // Database operations
        function addTransaction(transaction) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['transactions'], 'readwrite');
                const store = tx.objectStore('transactions');
                const request = store.add(transaction);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateTransaction(transaction) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['transactions'], 'readwrite');
                const store = tx.objectStore('transactions');
                const request = store.put(transaction);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteTransaction(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['transactions'], 'readwrite');
                const store = tx.objectStore('transactions');
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllTransactions() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['transactions'], 'readonly');
                const store = tx.objectStore('transactions');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function addBudget(budget) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['budgets'], 'readwrite');
                const store = tx.objectStore('budgets');
                const request = store.add(budget);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateBudget(budget) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['budgets'], 'readwrite');
                const store = tx.objectStore('budgets');
                const request = store.put(budget);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteBudget(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['budgets'], 'readwrite');
                const store = tx.objectStore('budgets');
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllBudgets() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['budgets'], 'readonly');
                const store = tx.objectStore('budgets');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function addDebt(debt) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['debts'], 'readwrite');
                const store = tx.objectStore('debts');
                debt.amountPaid = 0;
                debt.payments = [];
                const request = store.add(debt);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateDebt(debt) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['debts'], 'readwrite');
                const store = tx.objectStore('debts');
                const request = store.put(debt);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteDebt(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['debts'], 'readwrite');
                const store = tx.objectStore('debts');
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllDebts() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['debts'], 'readonly');
                const store = tx.objectStore('debts');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-AU', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('tab-active'));
                tab.classList.add('tab-active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tabName}-tab`).classList.remove('hidden');

                if (tabName === 'dashboard') updateDashboard();
                if (tabName === 'transactions') loadTransactions();
                if (tabName === 'budgets') loadBudgets();
                if (tabName === 'debts') loadDebts();
            });
        });

        // Transaction modal functions
        function openTransactionModal(transaction = null) {
            const modal = document.getElementById('transaction-modal');
            const form = document.getElementById('transaction-form');
            const title = document.getElementById('transaction-modal-title');

            if (transaction) {
                title.textContent = 'Edit Transaction';
                document.getElementById('transaction-id').value = transaction.id;
                document.getElementById('transaction-date').value = transaction.date;
                document.getElementById('transaction-description').value = transaction.description;
                document.getElementById('transaction-type').value = transaction.type;
                document.getElementById('transaction-amount').value = transaction.amount;
                document.getElementById('transaction-category').value = transaction.category;
                document.getElementById('transaction-account').value = transaction.account;
                document.getElementById('transaction-notes').value = transaction.notes || '';
            } else {
                title.textContent = 'Add Transaction';
                form.reset();
                document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            }

            updateCategoryOptions();
            modal.style.display = 'block';
        }

        function closeTransactionModal() {
            document.getElementById('transaction-modal').style.display = 'none';
            document.getElementById('transaction-form').reset();
        }

        function updateCategoryOptions() {
            const type = document.getElementById('transaction-type').value;
            const categorySelect = document.getElementById('transaction-category');
            const categories = CATEGORIES[type] || CATEGORIES.expense;

            categorySelect.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        document.getElementById('transaction-type').addEventListener('change', updateCategoryOptions);

        document.getElementById('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('transaction-id').value;
            const date = document.getElementById('transaction-date').value;
            const today = new Date().toISOString().split('T')[0];

            if (date > today) {
                alert('Date cannot be in the future');
                return;
            }

            const transaction = {
                date,
                description: document.getElementById('transaction-description').value,
                type: document.getElementById('transaction-type').value,
                amount: parseFloat(document.getElementById('transaction-amount').value),
                category: document.getElementById('transaction-category').value,
                account: document.getElementById('transaction-account').value,
                notes: document.getElementById('transaction-notes').value
            };

            if (transaction.amount <= 0) {
                alert('Amount must be greater than 0');
                return;
            }

            try {
                if (id) {
                    transaction.id = parseInt(id);
                    await updateTransaction(transaction);
                } else {
                    await addTransaction(transaction);
                }
                closeTransactionModal();
                loadTransactions();
                updateAccountBalances();
                if (document.getElementById('dashboard-tab').classList.contains('hidden') === false) {
                    updateDashboard();
                }
            } catch (error) {
                alert('Error saving transaction: ' + error.message);
            }
        });

        // Pagination
        let currentPage = 1;
        let itemsPerPage = 100;
        let filteredTransactions = [];

        async function loadTransactions(page = 1) {
            currentPage = page;
            const tbody = document.getElementById('transactions-tbody');
            const emptyState = document.getElementById('empty-transactions');

            try {
                const allTransactions = await getAllTransactions();

                // Apply filters
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const filterCategory = document.getElementById('filter-category').value;
                const filterAccount = document.getElementById('filter-account').value;
                const filterMonth = document.getElementById('filter-month').value;

                filteredTransactions = allTransactions.filter(t => {
                    if (searchTerm && !t.description.toLowerCase().includes(searchTerm)) return false;
                    if (filterCategory && t.category !== filterCategory) return false;
                    if (filterAccount && t.account !== filterAccount) return false;
                    if (filterMonth && !t.date.startsWith(filterMonth)) return false;
                    return true;
                });

                // Sort by date descending
                filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (filteredTransactions.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    document.getElementById('pagination').classList.add('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                document.getElementById('pagination').classList.remove('hidden');

                // Pagination
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

                tbody.innerHTML = pageTransactions.map(t => `
                    <tr>
                        <td class="px-4 py-3 text-sm">${formatDate(t.date)}</td>
                        <td class="px-4 py-3 text-sm">${t.description}</td>
                        <td class="px-4 py-3 text-sm">${t.category}</td>
                        <td class="px-4 py-3 text-sm">${t.account}</td>
                        <td class="px-4 py-3 text-sm text-right ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                            ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                        </td>
                        <td class="px-4 py-3 text-sm text-center">
                            <button onclick='editTransaction(${JSON.stringify(t)})' class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                            <button onclick="confirmDeleteTransaction(${t.id})" class="text-red-600 hover:text-red-800">Delete</button>
                        </td>
                    </tr>
                `).join('');

                // Update pagination controls
                const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
                document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prev-page').disabled = currentPage === 1;
                document.getElementById('next-page').disabled = currentPage >= totalPages;

            } catch (error) {
                alert('Error loading transactions: ' + error.message);
            }
        }

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) loadTransactions(currentPage - 1);
        });

        document.getElementById('next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (currentPage < totalPages) loadTransactions(currentPage + 1);
        });

        // Filter handling with debounce
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadTransactions(1), 300);
        });

        document.getElementById('filter-category').addEventListener('change', () => loadTransactions(1));
        document.getElementById('filter-account').addEventListener('change', () => loadTransactions(1));
        document.getElementById('filter-month').addEventListener('change', () => loadTransactions(1));

        function editTransaction(transaction) {
            openTransactionModal(transaction);
        }

        function confirmDeleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                deleteTransaction(id).then(() => {
                    loadTransactions(currentPage);
                    updateAccountBalances();
                    if (document.getElementById('dashboard-tab').classList.contains('hidden') === false) {
                        updateDashboard();
                    }
                }).catch(error => {
                    alert('Error deleting transaction: ' + error.message);
                });
            }
        }

        // Account balances
        async function updateAccountBalances() {
            try {
                const transactions = await getAllTransactions();
                const balances = { CBA: 0, Westpac: 0 };

                transactions.forEach(t => {
                    const amount = t.type === 'income' ? t.amount : -t.amount;
                    balances[t.account] = (balances[t.account] || 0) + amount;
                });

                document.getElementById('cba-balance').textContent = formatCurrency(balances.CBA);
                document.getElementById('westpac-balance').textContent = formatCurrency(balances.Westpac);

                // Update colors
                document.getElementById('cba-balance').className = balances.CBA >= 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
                document.getElementById('westpac-balance').className = balances.Westpac >= 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
            } catch (error) {
                console.error('Error updating balances:', error);
            }
        }

        // Dashboard
        let categoryChart, trendChart;

        async function updateDashboard() {
            try {
                const transactions = await getAllTransactions();
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // Filter current month transactions
                const monthTransactions = transactions.filter(t => {
                    const date = new Date(t.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                });

                const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const net = income - expenses;

                document.getElementById('total-income').textContent = formatCurrency(income);
                document.getElementById('total-expenses').textContent = formatCurrency(expenses);
                document.getElementById('net-balance').textContent = formatCurrency(net);
                document.getElementById('net-balance').className = net >= 0 ? 'text-3xl font-bold text-green-600' : 'text-3xl font-bold text-red-600';

                // Category breakdown
                updateCategoryChart(monthTransactions);

                // 6-month trend
                updateTrendChart(transactions);
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        function updateCategoryChart(transactions) {
            const expenseTransactions = transactions.filter(t => t.type === 'expense');
            const categoryTotals = {};

            expenseTransactions.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
            });

            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);

            if (categoryChart) {
                categoryChart.destroy();
            }

            const ctx = document.getElementById('category-chart').getContext('2d');

            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#9ca3af';
                ctx.textAlign = 'center';
                ctx.fillText('No expense data for this month', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6',
                            '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#6366f1',
                            '#84cc16', '#a855f7', '#22c55e', '#eab308'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 11 },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label}: ${formatCurrency(data.datasets[0].data[i])}`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    }));
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTrendChart(transactions) {
            const now = new Date();
            const monthsData = [];

            // Get last 6 months
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthStr = date.toLocaleString('en-AU', { month: 'short', year: '2-digit' });
                const year = date.getFullYear();
                const month = date.getMonth();

                const monthTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === month && tDate.getFullYear() === year;
                });

                const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

                monthsData.push({ label: monthStr, income, expenses, net: income - expenses });
            }

            if (trendChart) {
                trendChart.destroy();
            }

            const ctx = document.getElementById('trend-chart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthsData.map(m => m.label),
                    datasets: [
                        {
                            label: 'Income',
                            data: monthsData.map(m => m.income),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Expenses',
                            data: monthsData.map(m => m.expenses),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Net',
                            data: monthsData.map(m => m.net),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Budget functions
        function openBudgetModal(budget = null) {
            const modal = document.getElementById('budget-modal');
            const form = document.getElementById('budget-form');
            const categorySelect = document.getElementById('budget-category');

            categorySelect.innerHTML = CATEGORIES.expense.map(cat => `<option value="${cat}">${cat}</option>`).join('');

            if (budget) {
                document.getElementById('budget-id').value = budget.id;
                document.getElementById('budget-category').value = budget.category;
                document.getElementById('budget-limit').value = budget.limit;
            } else {
                form.reset();
            }

            modal.style.display = 'block';
        }

        function closeBudgetModal() {
            document.getElementById('budget-modal').style.display = 'none';
        }

        document.getElementById('budget-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('budget-id').value;
            const budget = {
                category: document.getElementById('budget-category').value,
                limit: parseFloat(document.getElementById('budget-limit').value)
            };

            if (budget.limit <= 0) {
                alert('Budget limit must be greater than 0');
                return;
            }

            try {
                if (id) {
                    budget.id = parseInt(id);
                    await updateBudget(budget);
                } else {
                    // Check if budget already exists for this category
                    const existingBudgets = await getAllBudgets();
                    const existing = existingBudgets.find(b => b.category === budget.category);
                    if (existing) {
                        if (confirm(`Budget for ${budget.category} already exists. Update it?`)) {
                            budget.id = existing.id;
                            await updateBudget(budget);
                        } else {
                            return;
                        }
                    } else {
                        await addBudget(budget);
                    }
                }
                closeBudgetModal();
                loadBudgets();
            } catch (error) {
                alert('Error saving budget: ' + error.message);
            }
        });

        async function loadBudgets() {
            try {
                const budgets = await getAllBudgets();
                const transactions = await getAllTransactions();
                const budgetsList = document.getElementById('budgets-list');
                const emptyState = document.getElementById('empty-budgets');

                if (budgets.length === 0) {
                    budgetsList.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');

                // Get current month transactions
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                const monthTransactions = transactions.filter(t => {
                    const date = new Date(t.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear && t.type === 'expense';
                });

                budgetsList.innerHTML = budgets.map(budget => {
                    const spent = monthTransactions
                        .filter(t => t.category === budget.category)
                        .reduce((sum, t) => sum + t.amount, 0);
                    const percentage = (spent / budget.limit) * 100;
                    const isOver = percentage > 100;

                    return `
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-semibold">${budget.category}</h3>
                                    <p class="text-sm text-gray-600">${formatCurrency(spent)} of ${formatCurrency(budget.limit)}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick='openBudgetModal(${JSON.stringify(budget)})' class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                    <button onclick="confirmDeleteBudget(${budget.id})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                </div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full ${isOver ? 'bg-red-600' : 'bg-blue-600'}" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                            <p class="text-xs text-right mt-1 ${isOver ? 'text-red-600 font-semibold' : 'text-gray-600'}">${percentage.toFixed(1)}% used</p>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                alert('Error loading budgets: ' + error.message);
            }
        }

        function confirmDeleteBudget(id) {
            if (confirm('Are you sure you want to delete this budget?')) {
                deleteBudget(id).then(() => {
                    loadBudgets();
                }).catch(error => {
                    alert('Error deleting budget: ' + error.message);
                });
            }
        }

        // Debt functions
        function openDebtModal(debt = null) {
            const modal = document.getElementById('debt-modal');
            const form = document.getElementById('debt-form');
            const title = document.getElementById('debt-modal-title');

            if (debt) {
                title.textContent = 'Edit Debt';
                document.getElementById('debt-id').value = debt.id;
                document.getElementById('debt-name').value = debt.name;
                document.getElementById('debt-total').value = debt.totalAmount;
            } else {
                title.textContent = 'Add Debt';
                form.reset();
            }

            modal.style.display = 'block';
        }

        function closeDebtModal() {
            document.getElementById('debt-modal').style.display = 'none';
        }

        document.getElementById('debt-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('debt-id').value;
            const debt = {
                name: document.getElementById('debt-name').value,
                totalAmount: parseFloat(document.getElementById('debt-total').value)
            };

            if (debt.totalAmount <= 0) {
                alert('Total amount must be greater than 0');
                return;
            }

            try {
                if (id) {
                    const existingDebts = await getAllDebts();
                    const existing = existingDebts.find(d => d.id === parseInt(id));
                    debt.id = parseInt(id);
                    debt.amountPaid = existing.amountPaid;
                    debt.payments = existing.payments;
                    await updateDebt(debt);
                } else {
                    await addDebt(debt);
                }
                closeDebtModal();
                loadDebts();
            } catch (error) {
                alert('Error saving debt: ' + error.message);
            }
        });

        async function loadDebts() {
            try {
                const debts = await getAllDebts();
                const debtsList = document.getElementById('debts-list');
                const emptyState = document.getElementById('empty-debts');

                if (debts.length === 0) {
                    debtsList.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');

                debtsList.innerHTML = debts.map(debt => {
                    const remaining = debt.totalAmount - debt.amountPaid;
                    const percentage = (debt.amountPaid / debt.totalAmount) * 100;

                    return `
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-semibold text-lg">${debt.name}</h3>
                                    <p class="text-sm text-gray-600">Total: ${formatCurrency(debt.totalAmount)}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="openPaymentModal(${debt.id})" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Pay</button>
                                    <button onclick='openDebtModal(${JSON.stringify(debt)})' class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                    <button onclick="confirmDeleteDebt(${debt.id})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Paid: ${formatCurrency(debt.amountPaid)}</span>
                                    <span class="font-semibold ${remaining > 0 ? 'text-red-600' : 'text-green-600'}">Remaining: ${formatCurrency(remaining)}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="h-2.5 rounded-full bg-green-600" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                            ${debt.payments && debt.payments.length > 0 ? `
                                <details class="mt-3">
                                    <summary class="text-sm text-blue-600 cursor-pointer hover:text-blue-800">Payment History (${debt.payments.length})</summary>
                                    <ul class="mt-2 space-y-1 text-sm">
                                        ${debt.payments.map(p => `
                                            <li class="flex justify-between text-gray-600">
                                                <span>${formatDate(p.date)}</span>
                                                <span class="font-semibold">${formatCurrency(p.amount)}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                alert('Error loading debts: ' + error.message);
            }
        }

        function confirmDeleteDebt(id) {
            if (confirm('Are you sure you want to delete this debt?')) {
                deleteDebt(id).then(() => {
                    loadDebts();
                }).catch(error => {
                    alert('Error deleting debt: ' + error.message);
                });
            }
        }

        // Payment modal
        function openPaymentModal(debtId) {
            const modal = document.getElementById('payment-modal');
            document.getElementById('payment-debt-id').value = debtId;
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            modal.style.display = 'block';
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
            document.getElementById('payment-form').reset();
        }

        document.getElementById('payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const debtId = parseInt(document.getElementById('payment-debt-id').value);
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;

            if (amount <= 0) {
                alert('Payment amount must be greater than 0');
                return;
            }

            try {
                const debts = await getAllDebts();
                const debt = debts.find(d => d.id === debtId);

                if (!debt) {
                    alert('Debt not found');
                    return;
                }

                const remaining = debt.totalAmount - debt.amountPaid;
                if (amount > remaining) {
                    if (!confirm(`Payment amount (${formatCurrency(amount)}) exceeds remaining balance (${formatCurrency(remaining)}). Continue?`)) {
                        return;
                    }
                }

                debt.amountPaid += amount;
                debt.payments = debt.payments || [];
                debt.payments.push({ date, amount });

                await updateDebt(debt);
                closePaymentModal();
                loadDebts();
            } catch (error) {
                alert('Error recording payment: ' + error.message);
            }
        });

        // Excel Import
        document.getElementById('excel-import').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);

                let importedCount = 0;
                let errorCount = 0;

                for (const sheetName of workbook.SheetNames) {
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    if (rows.length < 4) continue;

                    // Check header format (row 0: CBA/Westpac, row 2: column headers)
                    const headerRow0 = rows[0];
                    const headerRow2 = rows[2];

                    // Find CBA and Westpac sections
                    let cbaCol = headerRow0.findIndex(cell => cell === 'CBA');
                    let westpacCol = headerRow0.findIndex(cell => cell === 'Westpac');

                    if (cbaCol === -1 && westpacCol === -1) {
                        console.warn(`Sheet ${sheetName}: Invalid format (no CBA/Westpac headers)`);
                        continue;
                    }

                    // Process CBA transactions
                    if (cbaCol !== -1) {
                        for (let i = 3; i < rows.length; i++) {
                            try {
                                const row = rows[i];
                                if (!row || row.length === 0) continue;

                                const description = row[cbaCol + 1];
                                if (!description || description === 'Balance BF') continue;

                                const dateValue = row[cbaCol];
                                const category = row[cbaCol + 2] || 'Other';
                                const credit = parseFloat(row[cbaCol + 3]) || 0;
                                const debit = parseFloat(row[cbaCol + 4]) || 0;

                                if (!dateValue || (credit === 0 && debit === 0)) continue;

                                // Parse date
                                let date;
                                if (typeof dateValue === 'number') {
                                    // Excel date serial number
                                    date = XLSX.SSF.parse_date_code(dateValue);
                                    date = new Date(date.y, date.m - 1, date.d).toISOString().split('T')[0];
                                } else {
                                    date = new Date(dateValue).toISOString().split('T')[0];
                                }

                                const transaction = {
                                    date,
                                    description,
                                    category,
                                    account: 'CBA',
                                    type: credit > 0 ? 'income' : 'expense',
                                    amount: credit > 0 ? credit : debit,
                                    notes: `Imported from ${sheetName}`
                                };

                                await addTransaction(transaction);
                                importedCount++;
                            } catch (err) {
                                console.error(`Error importing CBA row ${i}:`, err);
                                errorCount++;
                            }
                        }
                    }

                    // Process Westpac transactions
                    if (westpacCol !== -1) {
                        for (let i = 3; i < rows.length; i++) {
                            try {
                                const row = rows[i];
                                if (!row || row.length === 0) continue;

                                const description = row[westpacCol + 1];
                                if (!description || description === 'Balance BF') continue;

                                const dateValue = row[westpacCol];
                                const category = row[westpacCol + 2] || 'Other';
                                const credit = parseFloat(row[westpacCol + 3]) || 0;
                                const debit = parseFloat(row[westpacCol + 4]) || 0;

                                if (!dateValue || (credit === 0 && debit === 0)) continue;

                                // Parse date
                                let date;
                                if (typeof dateValue === 'number') {
                                    date = XLSX.SSF.parse_date_code(dateValue);
                                    date = new Date(date.y, date.m - 1, date.d).toISOString().split('T')[0];
                                } else {
                                    date = new Date(dateValue).toISOString().split('T')[0];
                                }

                                const transaction = {
                                    date,
                                    description,
                                    category,
                                    account: 'Westpac',
                                    type: credit > 0 ? 'income' : 'expense',
                                    amount: credit > 0 ? credit : debit,
                                    notes: `Imported from ${sheetName}`
                                };

                                await addTransaction(transaction);
                                importedCount++;
                            } catch (err) {
                                console.error(`Error importing Westpac row ${i}:`, err);
                                errorCount++;
                            }
                        }
                    }
                }

                alert(`Import complete!\n${importedCount} transactions imported${errorCount > 0 ? `\n${errorCount} rows skipped due to errors` : ''}`);
                e.target.value = '';
                loadTransactions();
                updateAccountBalances();
                updateDashboard();
            } catch (error) {
                alert('Error importing Excel file: ' + error.message);
                e.target.value = '';
            }
        });

        // JSON Import
        document.getElementById('json-import').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (!data.transactions || !Array.isArray(data.transactions)) {
                    alert('Invalid JSON format');
                    return;
                }

                if (!confirm(`This will import ${data.transactions.length} transactions, ${data.budgets?.length || 0} budgets, and ${data.debts?.length || 0} debts. Continue?`)) {
                    return;
                }

                // Import transactions
                for (const t of data.transactions) {
                    delete t.id;
                    await addTransaction(t);
                }

                // Import budgets
                if (data.budgets) {
                    for (const b of data.budgets) {
                        delete b.id;
                        await addBudget(b);
                    }
                }

                // Import debts
                if (data.debts) {
                    for (const d of data.debts) {
                        delete d.id;
                        await addDebt(d);
                    }
                }

                alert('Import successful!');
                e.target.value = '';
                loadTransactions();
                updateAccountBalances();
                updateDashboard();
                loadBudgets();
                loadDebts();
            } catch (error) {
                alert('Error importing JSON: ' + error.message);
                e.target.value = '';
            }
        });

        // Excel Export
        async function exportToExcel() {
            try {
                const transactions = await getAllTransactions();

                if (transactions.length === 0) {
                    alert('No transactions to export');
                    return;
                }

                // Group by month
                const monthGroups = {};
                transactions.forEach(t => {
                    const date = new Date(t.date);
                    const monthKey = `${date.toLocaleString('en-AU', { month: 'short' })} ${date.getFullYear().toString().slice(-2)}`;
                    if (!monthGroups[monthKey]) {
                        monthGroups[monthKey] = { CBA: [], Westpac: [] };
                    }
                    monthGroups[monthKey][t.account].push(t);
                });

                const workbook = XLSX.utils.book_new();

                Object.keys(monthGroups).forEach(monthKey => {
                    const monthData = monthGroups[monthKey];
                    const cbaTransactions = monthData.CBA.sort((a, b) => new Date(a.date) - new Date(b.date));
                    const westpacTransactions = monthData.Westpac.sort((a, b) => new Date(a.date) - new Date(b.date));

                    const maxRows = Math.max(cbaTransactions.length, westpacTransactions.length);
                    const sheetData = [];

                    // Row 0: Account headers
                    sheetData.push(['CBA', '', '', '', '', '', 'Westpac', '', '', '', '']);

                    // Row 1: Empty
                    sheetData.push([]);

                    // Row 2: Column headers
                    sheetData.push(['Date', 'Description', 'Category', 'Credit', 'Debit', '', 'Date', 'Description', 'Category', 'Credit', 'Debit']);

                    // Data rows
                    for (let i = 0; i < maxRows; i++) {
                        const cba = cbaTransactions[i];
                        const westpac = westpacTransactions[i];

                        const row = [];

                        // CBA columns
                        if (cba) {
                            row.push(cba.date);
                            row.push(cba.description);
                            row.push(cba.category);
                            row.push(cba.type === 'income' ? cba.amount : '');
                            row.push(cba.type === 'expense' ? cba.amount : '');
                        } else {
                            row.push('', '', '', '', '');
                        }

                        row.push(''); // Separator

                        // Westpac columns
                        if (westpac) {
                            row.push(westpac.date);
                            row.push(westpac.description);
                            row.push(westpac.category);
                            row.push(westpac.type === 'income' ? westpac.amount : '');
                            row.push(westpac.type === 'expense' ? westpac.amount : '');
                        } else {
                            row.push('', '', '', '', '');
                        }

                        sheetData.push(row);
                    }

                    const worksheet = XLSX.utils.aoa_to_sheet(sheetData);
                    XLSX.utils.book_append_sheet(workbook, worksheet, monthKey);
                });

                XLSX.writeFile(workbook, `expense-tracker-${new Date().toISOString().split('T')[0]}.xlsx`);
            } catch (error) {
                alert('Error exporting to Excel: ' + error.message);
            }
        }

        // JSON Export
        async function exportToJSON() {
            try {
                const transactions = await getAllTransactions();
                const budgets = await getAllBudgets();
                const debts = await getAllDebts();

                const data = {
                    transactions,
                    budgets,
                    debts,
                    exportDate: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `expense-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error exporting to JSON: ' + error.message);
            }
        }

        // Clear all data
        async function clearAllData() {
            if (!confirm('Are you sure you want to delete ALL data? This cannot be undone!')) {
                return;
            }

            if (!confirm('This will permanently delete all transactions, budgets, and debts. Are you absolutely sure?')) {
                return;
            }

            try {
                const tx = db.transaction(['transactions', 'budgets', 'debts'], 'readwrite');
                tx.objectStore('transactions').clear();
                tx.objectStore('budgets').clear();
                tx.objectStore('debts').clear();

                await new Promise((resolve, reject) => {
                    tx.oncomplete = resolve;
                    tx.onerror = () => reject(tx.error);
                });

                alert('All data has been cleared');
                loadTransactions();
                updateAccountBalances();
                updateDashboard();
                loadBudgets();
                loadDebts();
            } catch (error) {
                alert('Error clearing data: ' + error.message);
            }
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        // Initialize category filter
        function initCategoryFilter() {
            const filterSelect = document.getElementById('filter-category');
            const allCategories = [...CATEGORIES.income, ...CATEGORIES.expense];
            filterSelect.innerHTML = '<option value="">All Categories</option>' +
                allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // Initialize app
        async function init() {
            try {
                await initDB();
                initCategoryFilter();
                updateAccountBalances();
                updateDashboard();

                // Set today's date as default
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('transaction-date').value = today;
                document.getElementById('payment-date').value = today;
            } catch (error) {
                alert('Error initializing app: ' + error.message);
            }
        }

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service worker registration is optional - app works without it
            });
        }

        // Start app
        init();
    </script>
</body>
</html>
