<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Income & Expense Tracker</title>
  <meta name="description" content="Offline-ready expense tracker for CBA and Westpac." />
  <meta name="theme-color" content="#0f766e" />
  <link rel="manifest" href="manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'DM Sans', sans-serif; }
    .tab-active { color: #0f766e; border-bottom: 3px solid #0f766e; }
    .modal { display:none; }
    .modal.open { display:flex; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="bg-white shadow sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <h1 class="text-xl md:text-2xl font-bold">Income & Expense Tracker</h1>
      <div class="flex items-center gap-3 text-sm">
        <div>CBA: <span id="cba-balance" class="font-bold">$0.00</span></div>
        <div>Westpac: <span id="westpac-balance" class="font-bold">$0.00</span></div>
        <button id="settings-btn" class="min-h-11 min-w-11 rounded-full border px-3">⚙️</button>
      </div>
    </div>
    <nav class="max-w-7xl mx-auto px-2 overflow-x-auto whitespace-nowrap">
      <button class="tab-btn tab-active px-4 py-3" data-tab="dashboard">Dashboard</button>
      <button class="tab-btn px-4 py-3" data-tab="transactions">Transactions</button>
      <button class="tab-btn px-4 py-3" data-tab="budgets">Budgets</button>
      <button class="tab-btn px-4 py-3" data-tab="debts">Debts</button>
      <button class="tab-btn px-4 py-3" data-tab="fixed">Fixed Costs</button>
      <button class="tab-btn px-4 py-3" data-tab="reports">Reports</button>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto p-4 space-y-4">
    <section id="dashboard" class="tab-pane space-y-4">
      <div class="grid md:grid-cols-3 gap-3">
        <div class="bg-white rounded-lg p-4 shadow"><p class="text-sm">Income (month)</p><p id="dash-income" class="text-2xl font-bold text-emerald-600">$0.00</p></div>
        <div class="bg-white rounded-lg p-4 shadow"><p class="text-sm">Expense (month)</p><p id="dash-expense" class="text-2xl font-bold text-rose-600">$0.00</p></div>
        <div class="bg-white rounded-lg p-4 shadow"><p class="text-sm">Net (month)</p><p id="dash-net" class="text-2xl font-bold">$0.00</p></div>
      </div>
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="bg-white rounded-lg p-4 shadow"><canvas id="pie-chart" height="160"></canvas></div>
        <div class="bg-white rounded-lg p-4 shadow"><canvas id="trend-chart" height="160"></canvas></div>
      </div>
    </section>

    <section id="transactions" class="tab-pane hidden bg-white rounded-lg shadow">
      <div class="p-4 border-b grid md:grid-cols-5 gap-2">
        <input id="f-search" class="border rounded px-3 py-2" placeholder="Search description" />
        <input id="f-date" type="month" class="border rounded px-3 py-2" />
        <select id="f-category" class="border rounded px-3 py-2"></select>
        <select id="f-account" class="border rounded px-3 py-2"><option value="">All accounts</option><option>CBA</option><option>Westpac</option></select>
        <button id="add-tx-btn" class="min-h-11 rounded bg-teal-700 text-white">+ Add</button>
      </div>
      <div id="tx-scroll" class="max-h-[60vh] overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 sticky top-0"><tr><th class="p-2 text-left">Date</th><th class="p-2 text-left">Description</th><th class="p-2">Category</th><th class="p-2">Account</th><th class="p-2 text-right">Amount</th><th class="p-2">Actions</th></tr></thead>
          <tbody id="tx-body"></tbody>
        </table>
      </div>
      <div class="p-3 border-t flex justify-between items-center">
        <button id="prev-page" class="border px-3 py-2 rounded">Prev</button>
        <span id="page-info"></span>
        <button id="next-page" class="border px-3 py-2 rounded">Next</button>
      </div>
      <p id="tx-empty" class="p-6 text-center hidden">No data yet - import Excel or add manually</p>
    </section>

    <section id="budgets" class="tab-pane hidden bg-white rounded-lg shadow p-4">
      <div class="flex justify-between mb-3"><h2 class="font-semibold text-lg">Budgets</h2><button id="add-budget-btn" class="min-h-11 px-4 rounded bg-teal-700 text-white">Add Budget</button></div>
      <div id="budget-list" class="space-y-3"></div>
      <p id="budget-empty" class="text-center p-6 hidden">No data yet - import Excel or add manually</p>
    </section>

    <section id="debts" class="tab-pane hidden bg-white rounded-lg shadow p-4">
      <div class="flex justify-between mb-3"><h2 class="font-semibold text-lg">Debts</h2><button id="add-debt-btn" class="min-h-11 px-4 rounded bg-teal-700 text-white">Add Debt</button></div>
      <div id="debt-list" class="space-y-3"></div>
      <p id="debt-empty" class="text-center p-6 hidden">No data yet - import Excel or add manually</p>
    </section>

    <section id="fixed" class="tab-pane hidden bg-white rounded-lg shadow p-4">
      <h2 class="font-semibold text-lg mb-3">Fixed Costs (import reference)</h2>
      <div id="fixed-list" class="space-y-2"></div>
      <p id="fixed-empty" class="text-center p-6 hidden">No data yet - import Excel or add manually</p>
    </section>

    <section id="reports" class="tab-pane hidden grid md:grid-cols-2 gap-4">
      <div class="bg-white rounded-lg shadow p-4 space-y-3">
        <h2 class="font-semibold text-lg">Import</h2>
        <input id="excel-input" type="file" accept=".xlsx,.xls" class="w-full" />
        <input id="json-input" type="file" accept=".json" class="w-full" />
      </div>
      <div class="bg-white rounded-lg shadow p-4 space-y-3">
        <h2 class="font-semibold text-lg">Export</h2>
        <button id="export-excel" class="min-h-11 w-full rounded bg-emerald-700 text-white">Export Excel</button>
        <button id="export-json" class="min-h-11 w-full rounded bg-sky-700 text-white">Export JSON</button>
      </div>
    </section>
  </main>

  <div id="toast" class="fixed bottom-4 right-4 bg-slate-900 text-white px-4 py-2 rounded hidden"></div>

  <div id="modal" class="modal fixed inset-0 bg-black/50 items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-4 w-full max-w-lg">
      <h3 id="modal-title" class="font-semibold text-lg mb-3"></h3>
      <form id="modal-form" class="space-y-3"></form>
      <div class="flex gap-2 mt-3">
        <button id="modal-save" class="min-h-11 flex-1 rounded bg-teal-700 text-white">Save</button>
        <button id="modal-cancel" class="min-h-11 flex-1 rounded border" type="button">Cancel</button>
      </div>
    </div>
  </div>

<script>
const DB_NAME = 'expense-tracker-db';
const DB_VERSION = 1;
const CATEGORIES = ['Income','Groceries','Dining Out','Transport','Fuel','Healthcare','Medication','Entertainment','Shopping','Utilities','Rent','Insurance','Savings','Debt Payment','Other'];
let db, pieChart, trendChart;
let txCache = [], page = 1, pageSize = 100, virtualStart = 0;

const $ = (s) => document.querySelector(s);
const money = (v) => `$${Number(v || 0).toFixed(2)}`;
const todayStr = () => new Date().toISOString().slice(0,10);
const toast = (m) => { const t=$('#toast'); t.textContent=m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2400); };

function excelDateToISO(v){
  if (typeof v === 'number') {
    const p = XLSX.SSF.parse_date_code(v);
    if (!p) return null;
    return `${p.y}-${String(p.m).padStart(2,'0')}-${String(p.d).padStart(2,'0')}`;
  }
  const d = new Date(v);
  return Number.isNaN(d.getTime()) ? null : d.toISOString().slice(0,10);
}

function validAmount(v){ return /^\d+(\.\d{1,2})?$/.test(String(v)) && Number(v) > 0; }
function notFuture(date){ return date <= todayStr(); }

async function initDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('transactions')) { const s=d.createObjectStore('transactions',{keyPath:'id',autoIncrement:true}); s.createIndex('date','date'); }
      if (!d.objectStoreNames.contains('budgets')) d.createObjectStore('budgets',{keyPath:'id',autoIncrement:true});
      if (!d.objectStoreNames.contains('debts')) d.createObjectStore('debts',{keyPath:'id',autoIncrement:true});
      if (!d.objectStoreNames.contains('fixedCosts')) d.createObjectStore('fixedCosts',{keyPath:'id',autoIncrement:true});
      if (!d.objectStoreNames.contains('settings')) d.createObjectStore('settings',{keyPath:'id'});
    };
    req.onsuccess = () => { db = req.result; resolve(); };
    req.onerror = () => reject(req.error);
  });
}

async function idb(op, store, value){
  try {
    return await new Promise((resolve,reject)=>{
      const tx = db.transaction(store, op === 'getAll' ? 'readonly' : 'readwrite');
      const s = tx.objectStore(store);
      let req;
      if (op==='add') req = s.add(value);
      if (op==='put') req = s.put(value);
      if (op==='delete') req = s.delete(value);
      if (op==='getAll') req = s.getAll();
      if (op==='clear') req = s.clear();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  } catch (e) { console.error('IDB error', op, store, e); throw e; }
}

function setTab(tab){
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.add('hidden'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('tab-active'));
  $('#' + tab).classList.remove('hidden');
  document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('tab-active');
}

function balanceColor(el, value){ el.className = `font-bold ${value >= 0 ? 'text-emerald-600':'text-rose-600'}`; }

async function renderHeaderAndDashboard(){
  const tx = await idb('getAll','transactions');
  const cba = tx.reduce((a,t)=>a + (t.account==='CBA' ? (t.type==='income'?t.amount:-t.amount):0),0);
  const west = tx.reduce((a,t)=>a + (t.account==='Westpac' ? (t.type==='income'?t.amount:-t.amount):0),0);
  $('#cba-balance').textContent = money(cba); balanceColor($('#cba-balance'), cba);
  $('#westpac-balance').textContent = money(west); balanceColor($('#westpac-balance'), west);

  const m = new Date().toISOString().slice(0,7);
  const monthTx = tx.filter(t=>t.date.startsWith(m));
  const income = monthTx.filter(t=>t.type==='income').reduce((a,t)=>a+t.amount,0);
  const expense = monthTx.filter(t=>t.type==='expense').reduce((a,t)=>a+t.amount,0);
  $('#dash-income').textContent = money(income);
  $('#dash-expense').textContent = money(expense);
  $('#dash-net').textContent = money(income-expense);

  const catMap = {};
  monthTx.filter(t=>t.type==='expense').forEach(t=>catMap[t.category]=(catMap[t.category]||0)+t.amount);
  const labels = Object.keys(catMap); const values = Object.values(catMap);
  pieChart?.destroy();
  pieChart = new Chart($('#pie-chart'), {type:'pie', data:{labels:labels.length?labels:['No data'], datasets:[{data:labels.length?values:[1]}]}});

  const lineLabels=[], inData=[], exData=[];
  for(let i=5;i>=0;i--){
    const d = new Date(); d.setMonth(d.getMonth()-i);
    const key = d.toISOString().slice(0,7); lineLabels.push(d.toLocaleDateString('en-AU',{month:'short'}));
    const arr = tx.filter(t=>t.date.startsWith(key));
    inData.push(arr.filter(t=>t.type==='income').reduce((a,t)=>a+t.amount,0));
    exData.push(arr.filter(t=>t.type==='expense').reduce((a,t)=>a+t.amount,0));
  }
  trendChart?.destroy();
  trendChart = new Chart($('#trend-chart'), {type:'line', data:{labels:lineLabels,datasets:[{label:'Income',data:inData,borderColor:'#059669'},{label:'Expense',data:exData,borderColor:'#dc2626'}]}, options:{animation:false}});
}

function categoryOptions(withAll=true){
  return (withAll?'<option value="">All categories</option>':'') + CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join('');
}

async function renderTransactions(){
  txCache = await idb('getAll','transactions');
  const s = $('#f-search').value.trim().toLowerCase();
  const m = $('#f-date').value;
  const c = $('#f-category').value;
  const a = $('#f-account').value;
  let list = txCache.filter(t => (!s || t.description.toLowerCase().includes(s)) && (!m || t.date.startsWith(m)) && (!c || t.category===c) && (!a || t.account===a));
  list.sort((x,y)=> y.date.localeCompare(x.date));

  const total = list.length;
  const pages = Math.max(1, Math.ceil(total / pageSize));
  if (page > pages) page = pages;
  $('#page-info').textContent = `Page ${page} / ${pages} (${total})`;

  if (total===0) { $('#tx-body').innerHTML=''; $('#tx-empty').classList.remove('hidden'); return; }
  $('#tx-empty').classList.add('hidden');

  let renderSet = list.slice((page-1)*pageSize, page*pageSize);
  if (total > 500) {
    const chunkSize = 120;
    virtualStart = Math.min(virtualStart, Math.max(0, renderSet.length - chunkSize));
    renderSet = renderSet.slice(virtualStart, virtualStart + chunkSize);
  }

  $('#tx-body').innerHTML = renderSet.map(t=>`<tr class="border-b"><td class="p-2">${t.date}</td><td class="p-2">${t.description}</td><td class="p-2 text-center">${t.category}</td><td class="p-2 text-center">${t.account}</td><td class="p-2 text-right ${t.type==='income'?'text-emerald-600':'text-rose-600'}">${t.type==='income'?'+':'-'}${money(t.amount)}</td><td class="p-2 text-center"><button class="text-sky-700" onclick="editTx(${t.id})">Edit</button> <button class="text-rose-700" onclick="delTx(${t.id})">Del</button></td></tr>`).join('');
}

function openModal(title, fields, onSave){
  $('#modal-title').textContent = title;
  $('#modal-form').innerHTML = fields;
  $('#modal').classList.add('open');
  $('#modal-save').onclick = async () => { try { await onSave(new FormData($('#modal-form'))); $('#modal').classList.remove('open'); await refreshAll(); } catch(e){ toast(e.message); } };
}

window.editTx = async (id) => {
  const item = (await idb('getAll','transactions')).find(t=>t.id===id);
  openModal('Edit Transaction', `
    <input name="date" type="date" required class="w-full border rounded px-3 py-2" value="${item.date}">
    <input name="description" required class="w-full border rounded px-3 py-2" value="${item.description}">
    <div class="grid grid-cols-2 gap-2"><select name="type" class="border rounded px-3 py-2"><option ${item.type==='income'?'selected':''}>income</option><option ${item.type==='expense'?'selected':''}>expense</option></select>
    <input name="amount" type="number" step="0.01" required class="border rounded px-3 py-2" value="${item.amount}"></div>
    <div class="grid grid-cols-2 gap-2"><select name="category" class="border rounded px-3 py-2">${CATEGORIES.map(c=>`<option ${item.category===c?'selected':''}>${c}</option>`).join('')}</select>
    <select name="account" class="border rounded px-3 py-2"><option ${item.account==='CBA'?'selected':''}>CBA</option><option ${item.account==='Westpac'?'selected':''}>Westpac</option></select></div>
    <textarea name="notes" class="w-full border rounded px-3 py-2">${item.notes||''}</textarea>`,
    async fd => { const t=Object.fromEntries(fd); if(!notFuture(t.date)) throw new Error('Date cannot be future'); if(!validAmount(t.amount)) throw new Error('Invalid amount'); await idb('put','transactions',{...item,...t,amount:Number(t.amount)}); });
};
window.delTx = async (id)=>{ if(confirm('Delete transaction?')){ await idb('delete','transactions',id); await refreshAll(); } };

async function renderBudgets(){
  const [budgets, tx] = await Promise.all([idb('getAll','budgets'), idb('getAll','transactions')]);
  const month = new Date().toISOString().slice(0,7);
  $('#budget-empty').classList.toggle('hidden', budgets.length>0);
  $('#budget-list').innerHTML = budgets.map(b=>{
    const spent = tx.filter(t=>t.type==='expense'&&t.category===b.category&&t.date.startsWith(month)).reduce((a,t)=>a+t.amount,0);
    const pct = b.limit ? (spent/b.limit)*100 : 0;
    const color = pct<80?'bg-emerald-500':pct<100?'bg-amber-500':'bg-rose-500';
    return `<div class="border rounded p-3"><div class="flex justify-between"><b>${b.category}</b><span>${money(spent)} / ${money(b.limit)}</span></div><div class="h-3 bg-slate-200 rounded mt-2"><div class="h-3 ${color} rounded" style="width:${Math.min(100,pct)}%"></div></div><div class="mt-2"><button onclick="editBudget(${b.id})" class="text-sky-700">Edit</button> <button onclick="delBudget(${b.id})" class="text-rose-700">Del</button></div></div>`;
  }).join('');
}
window.editBudget = async (id)=>{ const b=(await idb('getAll','budgets')).find(x=>x.id===id); openModal('Edit Budget',`<select name="category" class="w-full border rounded px-3 py-2">${CATEGORIES.filter(c=>c!=='Income').map(c=>`<option ${b.category===c?'selected':''}>${c}</option>`)}</select><input name="limit" type="number" step="0.01" class="w-full border rounded px-3 py-2" value="${b.limit}">`, async fd=>{const n=Object.fromEntries(fd); if(!validAmount(n.limit)) throw new Error('Invalid limit'); await idb('put','budgets',{...b,category:n.category,limit:Number(n.limit)});}); };
window.delBudget = async (id)=>{ if(confirm('Delete budget?')){ await idb('delete','budgets',id); await refreshAll(); } };

async function renderDebts(){
  const debts = await idb('getAll','debts');
  $('#debt-empty').classList.toggle('hidden', debts.length>0);
  $('#debt-list').innerHTML = debts.map(d=>{ const paid=d.paidAmount||0; const rem=Math.max(0,d.totalAmount-paid); return `<div class="border rounded p-3"><div class="flex justify-between"><b>${d.name}</b><span>${money(rem)} remaining</span></div><p class="text-sm">Total: ${money(d.totalAmount)} | Paid: ${money(paid)}</p><div class="mt-2"><button onclick="addPay(${d.id})" class="text-emerald-700">Add payment</button> <button onclick="editDebt(${d.id})" class="text-sky-700">Edit</button> <button onclick="delDebt(${d.id})" class="text-rose-700">Del</button></div><details class="mt-2"><summary>Payment history (${(d.payments||[]).length})</summary>${(d.payments||[]).map(p=>`<div class='text-sm'>${p.date} - ${money(p.amount)}</div>`).join('')}</details></div>`; }).join('');
}
window.editDebt = async (id)=>{ const d=(await idb('getAll','debts')).find(x=>x.id===id); openModal('Edit Debt',`<input name="name" class="w-full border rounded px-3 py-2" value="${d.name}"><input name="totalAmount" type="number" step="0.01" class="w-full border rounded px-3 py-2" value="${d.totalAmount}"><input name="paidAmount" type="number" step="0.01" class="w-full border rounded px-3 py-2" value="${d.paidAmount||0}">`, async fd=>{const n=Object.fromEntries(fd); if(!validAmount(n.totalAmount)) throw new Error('Invalid total'); await idb('put','debts',{...d,name:n.name,totalAmount:Number(n.totalAmount),paidAmount:Number(n.paidAmount||0)});}); };
window.delDebt = async (id)=>{ if(confirm('Delete debt?')){ await idb('delete','debts',id); await refreshAll(); } };
window.addPay = async (id)=>{ const d=(await idb('getAll','debts')).find(x=>x.id===id); openModal(`Payment: ${d.name}`,`<input name="date" type="date" value="${todayStr()}" class="w-full border rounded px-3 py-2"><input name="amount" type="number" step="0.01" class="w-full border rounded px-3 py-2" placeholder="Amount">`, async fd=>{const n=Object.fromEntries(fd); if(!notFuture(n.date)) throw new Error('Date cannot be future'); if(!validAmount(n.amount)) throw new Error('Invalid payment'); d.paidAmount=(d.paidAmount||0)+Number(n.amount); d.payments=d.payments||[]; d.payments.push({date:n.date,amount:Number(n.amount)}); await idb('put','debts',d);}); };

async function renderFixedCosts(){
  const rows = await idb('getAll','fixedCosts');
  $('#fixed-empty').classList.toggle('hidden', rows.length>0);
  $('#fixed-list').innerHTML = rows.map(f=>`<div class="border rounded p-3"><div class="font-semibold">${f.type}</div><div>${f.description}</div><div class="text-sm">${money(f.amount)} • ${f.frequency}</div></div>`).join('');
}

function parseMonthlySheet(rows, sheetName, out){
  for (let r=3; r<rows.length; r++) {
    const row = rows[r] || [];
    const parts = [
      {offset:0, account:'Westpac'},
      {offset:6, account:'CBA'}
    ];
    for (const part of parts) {
      const date = excelDateToISO(row[part.offset]);
      const description = String(row[part.offset+1] || '').trim();
      const category = String(row[part.offset+2] || 'Other').trim();
      const credit = Number(row[part.offset+3] || 0);
      const debit = Number(row[part.offset+4] || 0);
      if (!description || description === 'Balance BF') continue;
      if (!date || (!credit && !debit)) continue;
      if (!notFuture(date)) continue;
      if (credit) out.transactions.push({date,description,category,amount:credit,type:'income',account:part.account,notes:`Imported from ${sheetName}`});
      if (debit) out.transactions.push({date,description,category,amount:debit,type:'expense',account:part.account,notes:`Imported from ${sheetName}`});
    }
  }
}

function parseTrackSheet(rows, out){
  for (let i=1;i<rows.length;i++){
    const cat = String(rows[i]?.[0] || '').trim();
    const allowance = Number(rows[i]?.[1] || 0);
    if (!cat || cat.toLowerCase()==='income') continue;
    if (allowance>0) out.budgets.push({category:cat,limit:allowance});
  }
}
function parseDebtSheet(rows,out){
  for (let i=1;i<rows.length;i++){
    const name = String(rows[i]?.[1]||'').trim();
    const amount = Number(rows[i]?.[2]||0);
    const paidRaw = rows[i]?.[3];
    const paid = Number(String(paidRaw).split(/[^0-9.]/)[0]) || 0;
    if (name && amount>0) out.debts.push({name,totalAmount:amount,paidAmount:paid,payments:[]});
  }
}
function parseFixedCosts(rows,out){
  for (let i=1;i<rows.length;i++){
    const type=String(rows[i]?.[0]||'').trim();
    const description=String(rows[i]?.[1]||'').trim();
    const amount=Number(rows[i]?.[2]||0);
    const frequency=String(rows[i]?.[3]||'').trim();
    if (type && description && amount>0) out.fixedCosts.push({type,description,amount,frequency});
  }
}

async function importExcel(file){
  const wb = XLSX.read(await file.arrayBuffer());
  const out = {transactions:[],budgets:[],debts:[],fixedCosts:[],errors:[]};
  console.log('Workbook sheets:', wb.SheetNames);
  for (const sheetName of wb.SheetNames) {
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header:1, raw:true});
    const n = sheetName.toLowerCase();
    try {
      if (/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s+\d{2}$/.test(n)) parseMonthlySheet(rows, sheetName, out);
      else if (n.includes('track')) parseTrackSheet(rows, out);
      else if (n.includes('debt')) parseDebtSheet(rows, out);
      else if (n.includes('fixed')) parseFixedCosts(rows, out);
    } catch (e) { out.errors.push(`${sheetName}: ${e.message}`); }
  }
  for (const t of out.transactions) await idb('add','transactions',t);
  const existingB = await idb('getAll','budgets');
  for (const b of out.budgets) { const x=existingB.find(e=>e.category===b.category); x ? await idb('put','budgets',{...x,limit:b.limit}) : await idb('add','budgets',b); }
  for (const d of out.debts) await idb('add','debts',d);
  await idb('clear','fixedCosts');
  for (const f of out.fixedCosts) await idb('add','fixedCosts',f);
  toast(`Imported ${out.transactions.length} tx, ${out.budgets.length} budgets, ${out.debts.length} debts, ${out.fixedCosts.length} fixed costs${out.errors.length?` (${out.errors.length} errors)`:''}`);
}

async function exportExcel(){
  const tx = await idb('getAll','transactions');
  const budgets = await idb('getAll','budgets');
  const debts = await idb('getAll','debts');
  const fixed = await idb('getAll','fixedCosts');
  const wb = XLSX.utils.book_new();
  const byMonth = {};
  tx.forEach(t=>{ const d=new Date(t.date); const key=`${d.toLocaleDateString('en-AU',{month:'short'})} ${String(d.getFullYear()).slice(2)}`; (byMonth[key] ||= []).push(t); });
  Object.entries(byMonth).forEach(([month, list])=>{
    const cba = list.filter(t=>t.account==='CBA').sort((a,b)=>a.date.localeCompare(b.date));
    const west = list.filter(t=>t.account==='Westpac').sort((a,b)=>a.date.localeCompare(b.date));
    const n = Math.max(cba.length,west.length);
    const rows = [["CBA",0,"WBA",0,null,null,"CBA",0,"WBA",0],["Westpac",null,null,null,null,null,"Commonwealth Bank"],["Date","Description","Category","Credit (+)","Debit (-)",null,"Date","Description","Category","Credit (+)","Debit (-)"]];
    for(let i=0;i<n;i++){
      const w=west[i], c=cba[i];
      rows.push([w?.date||'',w?.description||'',w?.category||'',w?.type==='income'?w.amount:'',w?.type==='expense'?w.amount:'',null,c?.date||'',c?.description||'',c?.category||'',c?.type==='income'?c.amount:'',c?.type==='expense'?c.amount:'']);
    }
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), month);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["Type","Description","Amount","Frequency"], ...fixed.map(f=>[f.type,f.description,f.amount,f.frequency])]), 'Fixed Costs');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["Item","Name","Amount","Paid Amount & Date"], ...debts.map((d,i)=>[i+1,d.name,d.totalAmount,d.paidAmount||0])]), 'Debt');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([[null],["Category","Allowance","Jan","Feb"],["Income","-","-","-"],...budgets.map(b=>[b.category,b.limit])]), 'Track');
  XLSX.writeFile(wb, `expense-tracker-${todayStr()}.xlsx`);
}

async function exportJSON(){
  const payload = {
    transactions: await idb('getAll','transactions'),
    budgets: await idb('getAll','budgets'),
    debts: await idb('getAll','debts'),
    fixedCosts: await idb('getAll','fixedCosts'),
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`expense-backup-${todayStr()}.json`; a.click();
}

async function importJSON(file){
  const data = JSON.parse(await file.text());
  if (!Array.isArray(data.transactions)) throw new Error('Invalid backup format');
  for (const k of ['transactions','budgets','debts','fixedCosts']) await idb('clear',k);
  for (const x of data.transactions) { delete x.id; await idb('add','transactions',x); }
  for (const x of (data.budgets||[])) { delete x.id; await idb('add','budgets',x); }
  for (const x of (data.debts||[])) { delete x.id; await idb('add','debts',x); }
  for (const x of (data.fixedCosts||[])) { delete x.id; await idb('add','fixedCosts',x); }
  toast('Backup restored');
}

const debouncedTxRender = (()=>{ let t; return ()=>{ clearTimeout(t); t=setTimeout(()=>renderTransactions(),300); };})();

async function refreshAll(){ await renderHeaderAndDashboard(); await renderTransactions(); await renderBudgets(); await renderDebts(); await renderFixedCosts(); }

async function boot(){
  await initDB();
  $('#f-category').innerHTML = categoryOptions(true);
  document.querySelectorAll('.tab-btn').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));
  $('#modal-cancel').onclick = ()=>$('#modal').classList.remove('open');
  $('#settings-btn').onclick = ()=>toast('Settings store is ready for future preferences.');

  $('#add-tx-btn').onclick = ()=>openModal('Add Transaction', `
    <input name="date" type="date" value="${todayStr()}" required class="w-full border rounded px-3 py-2">
    <input name="description" required class="w-full border rounded px-3 py-2" placeholder="Description">
    <div class="grid grid-cols-2 gap-2"><select name="type" class="border rounded px-3 py-2"><option>expense</option><option>income</option></select>
    <input name="amount" type="number" step="0.01" required class="border rounded px-3 py-2" placeholder="Amount"></div>
    <div class="grid grid-cols-2 gap-2"><select name="category" class="border rounded px-3 py-2">${CATEGORIES.map(c=>`<option>${c}</option>`).join('')}</select>
    <select name="account" class="border rounded px-3 py-2"><option>CBA</option><option>Westpac</option></select></div>
    <textarea name="notes" class="w-full border rounded px-3 py-2" placeholder="Notes"></textarea>`,
    async fd=>{ const t=Object.fromEntries(fd); if(!notFuture(t.date)) throw new Error('Date cannot be future'); if(!t.description||!t.category||!t.account||!t.type) throw new Error('Required fields missing'); if(!validAmount(t.amount)) throw new Error('Invalid amount'); await idb('add','transactions',{...t,amount:Number(t.amount)}); });

  $('#add-budget-btn').onclick = ()=>openModal('Add Budget', `<select name="category" class="w-full border rounded px-3 py-2">${CATEGORIES.filter(c=>c!=='Income').map(c=>`<option>${c}</option>`).join('')}</select><input name="limit" type="number" step="0.01" class="w-full border rounded px-3 py-2">`, async fd=>{const b=Object.fromEntries(fd); if(!validAmount(b.limit)) throw new Error('Invalid limit'); await idb('add','budgets',{category:b.category,limit:Number(b.limit)});});
  $('#add-debt-btn').onclick = ()=>openModal('Add Debt', `<input name="name" class="w-full border rounded px-3 py-2" placeholder="Name"><input name="totalAmount" type="number" step="0.01" class="w-full border rounded px-3 py-2" placeholder="Total amount"><input name="paidAmount" type="number" step="0.01" class="w-full border rounded px-3 py-2" value="0">`, async fd=>{const d=Object.fromEntries(fd); if(!d.name||!validAmount(d.totalAmount)) throw new Error('Invalid debt'); await idb('add','debts',{name:d.name,totalAmount:Number(d.totalAmount),paidAmount:Number(d.paidAmount||0),payments:[]});});

  $('#f-search').addEventListener('input', debouncedTxRender);
  $('#f-date').addEventListener('change', ()=>renderTransactions());
  $('#f-category').addEventListener('change', ()=>renderTransactions());
  $('#f-account').addEventListener('change', ()=>renderTransactions());
  $('#prev-page').onclick = ()=>{ if(page>1){ page--; renderTransactions(); } };
  $('#next-page').onclick = ()=>{ page++; renderTransactions(); };
  $('#tx-scroll').addEventListener('scroll', (e)=>{ if(txCache.length>500){ const top=e.target.scrollTop; virtualStart=Math.floor(top/34); renderTransactions(); }});

  $('#excel-input').onchange = async (e)=>{ if(e.target.files[0]){ try{ await importExcel(e.target.files[0]); await refreshAll(); } catch(err){ toast('Excel import failed: '+err.message);} e.target.value=''; } };
  $('#json-input').onchange = async (e)=>{ if(e.target.files[0]){ try{ await importJSON(e.target.files[0]); await refreshAll(); } catch(err){ toast('JSON import failed: '+err.message);} e.target.value=''; } };
  $('#export-excel').onclick = exportExcel;
  $('#export-json').onclick = exportJSON;

  if ('serviceWorker' in navigator) {
    const swBlob = new Blob([`self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('fetch',()=>{});`], {type:'text/javascript'});
    navigator.serviceWorker.register(URL.createObjectURL(swBlob));
  }
  await refreshAll();
}

boot().catch(e=>{ console.error(e); toast('Failed to initialize app'); });
</script>
</body>
</html>
